"""
Chess Engine Performance Data Collector

This script collects all JSON performance data files generated by the Chess Engine Performance Tests,
parses them, and organizes the data by app version and time frame
for later analysis and visualization
"""

import json
import os
import glob
from datetime import datetime
from dataclasses import dataclass, field
from typing import Dict, List,Any

@dataclass
class PerformanceData:
    """Container for performance test data"""
    app_version: str
    timestamp: datetime
    test_group: str
    test_file: str
    results : List[Dict[str, Any]]
    file_path: str

@dataclass
class DataCollection:
    """Main data collection container"""
    data_by_version : Dict[str, List[PerformanceData]] = field(default_factory=dict)
    data_by_timeframe : Dict[str, List[PerformanceData]] = field(default_factory=dict)
    all_data: List[PerformanceData] = field(default_factory=list)

    def add_data(self, perf_data: PerformanceData):
        """Add performance data to the collection"""
        self.all_data.append(perf_data)

        # Group by version
        if perf_data.app_version not in self.data_by_version:
            self.data_by_version[perf_data.app_version]=[]
        self.data_by_version[perf_data.app_version].append(perf_data)

        # Groud by timeframe (daily)
        timeframe_key = perf_data.timestamp.strftime("%Y-%m-%d")
        if timeframe_key not in self.data_by_timeframe:
            self.data_by_timeframe[timeframe_key] = []
        self.data_by_timeframe[timeframe_key].append(perf_data)


class PerformanceDataCollector:
    """Collects and organizes Chess Engine Performance data"""

    def __init__(self):
        """ Intitialize the data collector"""
        self.base_directory = os.path.join(os.getcwd(), "..", "build", "Chess.Engine.Performance", "Debug", "Performance_Results")  # adapt to config later
        self.collection = DataCollection()
        self.supported_test_types = ["move_generation", "positional_evaluation", "move_evaluation", "lightchessboard", "cpu_player", "cpu_performance"]

    def find_json_files(self) -> List[str]:
        """Find all JSON performance result files"""
        search_patterns = [
            "**/Performance_Results/*.json",
            "**/CPU_VS_CPU_Results/*.json", 
            "**/*performance*.json",
            "**/*_performance_*.json"        
            ]
        
        json_files = []
        for pattern in search_patterns:
            files = glob.glob(os.path.join(self.base_directory, pattern), recursive=True)
            json_files.extend(files)

        # remove duplicates and sort
        return sorted(list(set(json_files)))
    



